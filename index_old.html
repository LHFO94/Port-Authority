<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Port Authority</title>
  <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
  <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
  <script src=https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.3.0/math.min.js></script>
  <script src="utils.js"></script>
  <script type="text/javascript">

    //Aliases
    let Container = PIXI.Container,
    autoDetectRenderer = PIXI.autoDetectRenderer,
    loader = PIXI.Loader.shared,
    TextureCache = PIXI.utils.TextureCache,
    resources = PIXI.Loader.shared.resources,
    Sprite = PIXI.Sprite;

    //Create the stage and renderer
    let stage = new Container();
    let spriteContainer = new PIXI.ParticleContainer(); 
    stage.addChild(spriteContainer);
    renderer = autoDetectRenderer(256, 256);
    renderer.backgroundColor = "0x0492C2";    
    document.body.appendChild(renderer.view);

    var width = renderer.width;
    var height = renderer.height;

    //Load an image and call the `setup` function
    loader
    .add("images/tilesheet.png")
    .on("progress", loadProgressHandler)
    .load(setup);

    function loadProgressHandler(loader, resource) {
    //Display the file `url` currently being loaded
      console.log(`loading: ${resource.url}`);
      //Display the percentage of files currently loaded
      console.log(`progress: ${loader.progress}`);
    }

    let state = play; 

    function setup() {

      let numberOfShips = 5,
          spacing = 200,
          xOffset = 150;

      for (let i = 0; i < numberOfShips; i++) {
        //Create the sprite, add it to the stage and render it
        let ship1 = new Sprite(frame("images/tilesheet.png", 0,0,20,100))
        let ship2 = new Sprite(frame("images/tilesheet.png", 30,0,25,130))
        let ship3 = new Sprite(frame("images/tilesheet.png", 230,0,25,115))
        let ships = [ship1, ship2, ship3]
        let randomShip = getRandomInt(3);
        let ship = ships[randomShip];

        let x = spacing * i + xOffset;
        let y = getRandomInt(renderer.height);

        let possible_rotations = [0, 90, 180, 270];
        let angle_index = math.floor(Math.random() * possible_rotations.length)
        let angle = possible_rotations[angle_index]

        ship.x = x;
        ship.y = y;
        ship.vx = 0;
        ship.vy = 0;
        ship.anchor.x = 0.5;
        ship.anchor.y = 0.5;
        ship.angle = angle;
          // Opt-in to interactivity
        ship.interactive = true;

        // Shows hand cursor
        ship.buttonMode = true;
        ship.on('pointerdown', onClick);

        //console.log(`${i} ${randomShip} ${ship.x}`);
        spriteContainer.addChild(ship);

      }
      gameLoop();
    }
    
    function gameLoop() {
      // Loop this animation at 60fps
      requestAnimationFrame(gameLoop);
      // Update the current game state
      state();
      // Render the stage to see the animation
      renderer.render(stage)
    }

    function play() {
      spriteContainer.children.forEach(ship => {
        contain(ship, width, height)
        moveShip(ship,1)
        console.log(ship.angle)
      }) 

    }  

    function frame(source, x, y, width, height) {

      var texture = undefined,
      imageFrame = undefined;

      //If the source is a string, it's either a texture in the
      //cache or an image file
      if (typeof source === "string") {
        if (TextureCache[source]) {
          texture = new PIXI.Texture(TextureCache[source]);
        }
      }

      //If the `source` is a texture,  use it
      else if (source instanceof this.Texture) {
          texture = new PIXI.Texture(source);
        }
      if (!texture) {
        throw new Error("Please load the " + source + " texture into the cache.");
      } else {

        //Make a rectangle the size of the sub-image
        imageFrame = new PIXI.Rectangle(x, y, width, height);
        texture.frame = imageFrame;
        return texture;
      }
    }
    // Function that makes a ship move in the direction of its rotation
    function moveShip(ship, speed) {
      let angle = ship.angle
      // move up
      if (angle == 0) {
        ship.vy = -speed;
        ship.y += ship.vy;
        // move right
      } else if (angle == 90) {
        ship.xy = speed;
        ship.x += ship.xy;
        // move down
      } else if (angle == 180) {
        ship.vy = speed;
        ship.y += ship.vy;
        // move left
      } else {
        ship.vx = -speed;
        ship.x += ship.vx;
      }
      return ship
    }

    function contain(ship, screen_width, screen_height) {
      let x = ship.x;
      let y = ship.y;
      let width = screen_width;
      let heigth = screen_height;

      if (y <= 0) {
        ship.angle = 180;
      } else if (y >= heigth -10) {
        ship.angle = 0;
      } else if (x <= 0) {
        ship.angle = 90;
      } else if (x >= width -10) {
        ship.angle = 270;
      }
      return ship
    }

    function keyboard(keyCode) {
      var key = {};
      key.code = keyCode;
      key.isDown = false;
      key.isUp = true;
      key.press = undefined;
      key.release = undefined;

      //The `downHandler`
      key.downHandler = function(event) {
        if (event.keyCode === key.code) {
          if (key.isUp && key.press) key.press();
          key.isDown = true;
          key.isUp = false;
        }
        event.preventDefault();
      };

      //The `upHandler`
      key.upHandler = function(event) {
        if (event.keyCode === key.code) {
          if (key.isDown && key.release) key.release();
          key.isDown = false;
          key.isUp = true;
        }
        event.preventDefault();
      };

      //Attach event listeners
      window.addEventListener(
        "keydown", key.downHandler.bind(key), false
      );
      window.addEventListener(
        "keyup", key.upHandler.bind(key), false
      );

      //Return the `key` object
      return key;
    }

    function getRandomInt(max) {
      return Math.floor(Math.random() * max);
    }

    // event listener for window resizing
    window.addEventListener("resize", event => {
      scaleToWindow(renderer.view)
    })

    function onClick() {
    sprite.scale.x *= 1.25;
    sprite.scale.y *= 1.25;
    }

  </script>
</body>
</html>